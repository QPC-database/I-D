<?xml version='1.0' encoding='utf-8'?>
<?xml-stylesheet type="text/xsl" href="rfc2629.xslt" ?>
<!-- generated by https://github.com/cabo/kramdown-rfc2629 version 1.3.35 -->
<!DOCTYPE rfc SYSTEM "../Tools/rfcbootstrap/rfc2629-xhtml.ent">
<?rfc toc="yes"?>
<?rfc tocindent="yes"?>
<?rfc sortrefs="yes"?>
<?rfc symrefs="yes"?>
<?rfc strict="yes"?>
<?rfc compact="yes"?>
<?rfc comments="yes"?>
<?rfc inline="yes"?>
<rfc xmlns:xi="http://www.w3.org/2001/XInclude" ipr="trust200902" docName="draft-nottingham-cache-trailers-00" category="std" obsoletes="" updates="" submissionType="IETF" xml:lang="en" tocInclude="true" sortRefs="true" symRefs="true" version="3">
  <!-- xml2rfc v2v3 conversion 3.5.0 -->
  <front>
    <title>Updating HTTP Caching Policy in Trailers</title>
    <seriesInfo name="Internet-Draft" value="draft-nottingham-cache-trailers-00"/>
    <author initials="M." surname="Nottingham" fullname="Mark Nottingham">
      <organization/>
      <address>
        <postal>
          <city>Prahran</city>
          <region>VIC</region>
          <country>Australia</country>
        </postal>
        <email>mnot@mnot.net</email>
        <uri>https://www.mnot.net/</uri>
      </address>
    </author>
    <date year="2021"/>
    <area>General</area>
    <keyword>Internet-Draft</keyword>
    <abstract>
      <t>This specification defines how to update caching policy for a response in HTTP trailer fields, after the content has been sent.</t>
    </abstract>
    <note>
      <name>Note to Readers</name>
      <t><em>RFC EDITOR: please remove this section before publication</em></t>
      <t>The issues list for this draft can be found at <eref target="https://github.com/mnot/I-D/labels/cache-trailers">https://github.com/mnot/I-D/labels/cache-trailers</eref>.</t>
      <t>The most recent (often, unpublished) draft is at <eref target="https://mnot.github.io/I-D/cache-trailers/">https://mnot.github.io/I-D/cache-trailers/</eref>.</t>
      <t>Recent changes are listed at <eref target="https://github.com/mnot/I-D/commits/gh-pages/cache-trailers">https://github.com/mnot/I-D/commits/gh-pages/cache-trailers</eref>.</t>
      <t>See also the draft's current status in the IETF datatracker, at
<eref target="https://datatracker.ietf.org/doc/draft-nottingham-cache-trailers/">https://datatracker.ietf.org/doc/draft-nottingham-cache-trailers/</eref>.</t>
    </note>
  </front>
  <middle>
    <section anchor="introduction" numbered="true" toc="default">
      <name>Introduction</name>
      <t>Web content that is "dynamically" generated - i.e., with the response body streamed by the server to the client as it is created - is often assumed to be uncacheable. In practice, though, there are some scenarios where caching is highly beneficial; for example, when a private cache might be able to reuse a personalised, dynamic response for a period, or when such a response can be shared by a number of clients for a period.</t>
      <t>However, a server choosing a caching policy for such a response faces a conundrum: if an error or other unforeseen condition happens during the generation of the response, that caching policy might be too liberal. Currently, the only available solutions are to:</t>
      <ol spacing="normal" type="1"><li>prevent or severely curtail downstream caching, or</li>
        <li>buffer the response until a caching policy can be confidently assigned.</li>
      </ol>
      <t>In both cases, performance suffers; in the former, caching efficiency is less than it could be in the common case, In the latter, the server consumes additional resources and delays the response.</t>
      <t>This specification provides a third solution: updating the caching policy in HTTP trailer fields, after the content has been sent. Doing so allows content to be streamed, while caching policy can be determined after the content is actually generated.</t>
      <section anchor="notational-conventions" numbered="true" toc="default">
        <name>Notational Conventions</name>
        <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
"RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as
described in BCP 14 <xref target="RFC2119" format="default"/> <xref target="RFC8174" format="default"/> when, and only when, they appear in all capitals, as
shown here.</t>
      </section>
    </section>
    <section anchor="the-trailer-update-http-cache-directive" numbered="true" toc="default">
      <name>The "trailer-update" HTTP Cache Directive</name>
      <t>An HTTP response containing the "trailer-update" cache response directive in its Cache-Control header field is considered to be an eligible response for the purposes of this specification.</t>
      <t>Upon receiving a Cache-Control field in the trailer section of an eligible response, caches that implement this specification MUST completely replace the stored Cache-Control header field value for that response with the trailer field's value, MUST update its handling of that response to account for the new field value (after any outstanding requests are satisfied), and MUST use that value for the Cache-Control header field in responses to future requests satisfied from that cache entry (i.e., the trailer field is "promoted" to a header field).</t>
      <t>In responses where the trailer field value has replaced the heder field value, the "trailer-update" directive will have been removed as part of that process.</t>
      <t>Caches MAY temporarily store a response that has a Cache-Control header field with both the "no-store" and "trailer-update" directives, but MUST NOT reuse that response until the caching policy is updated in a manner that allows it. If the caching policy is not updated or the "no-store" directive is still present in the updated response, the cache MUST immediately and permanently discard the temporarily stored response.</t>
      <section anchor="examples" numbered="true" toc="default">
        <name>Examples</name>
        <t>Given a resource that supports this specification but encounters no errors in the generation of a response's content, that response might look like this:</t>
        <artwork type="http-message" name="" align="left" alt=""><![CDATA[
HTTP/1.1 200 OK
Content-Type: text/html
Cache-Control: max-age=3600, trailer-update

[body]
]]></artwork>
        <t>Caches that do not implement this specification will cache it by the header policy; caches that do implement will see no updates in the trailer and do the same.</t>
        <t>If a change in caching policy is encountered during the generation of the response content, the resource can prevent reuse by caches that implement this specification by sending:</t>
        <artwork type="http-message" name="" align="left" alt=""><![CDATA[
HTTP/1.1 200 OK
Content-Type: text/html
Cache-Control: max-age=3600, trailer-update

[body]
Cache-Control: no-store
]]></artwork>
        <t>In this case, caches that do not implement this specification will again act as instructed by the header policy, but caches that do implement will see the update in the trailers and prevent reuse of the response after the trailer is received (although it might have been used to satisfy requests that were received in the meantime).</t>
        <t>If a resource wishes to prevent non-implementing caches from storing the response, they can send:</t>
        <artwork type="http-message" name="" align="left" alt=""><![CDATA[
HTTP/1.1 200 OK
Content-Type: text/html
Cache-Control: no-store; trailer-update

[body]
Cache-Control: max-age=3600
]]></artwork>
        <t>Here, a non-implementing cache will only see "no-store", and so will not store the response. An implementing cache can optimistically store the response based upon "trailer-update", but only allow its reuse after the caching policy is updated to something which permits that in trailers.</t>
        <t>Note that when a downstream cache does not implement this specification, and also does not forward a message's trailer section (as allowed by HTTP), any updates will effectively be lost, even if further downstream caches do implement.</t>
      </section>
    </section>
    <section anchor="iana-considerations" numbered="true" toc="default">
      <name>IANA Considerations</name>
      <t><em>TBD</em></t>
    </section>
    <section anchor="security-considerations" numbered="true" toc="default">
      <name>Security Considerations</name>
      <t><em>TBD</em></t>
    </section>
  </middle>
  <back>
    <references>
      <name>Normative References</name>
      <reference anchor="RFC2119" target="https://www.rfc-editor.org/info/rfc2119">
        <front>
          <title>Key words for use in RFCs to Indicate Requirement Levels</title>
          <author fullname="S. Bradner" initials="S." surname="Bradner">
            <organization/>
          </author>
          <date month="March" year="1997"/>
          <abstract>
            <t>In many standards track documents several words are used to signify the requirements in the specification.  These words are often capitalized. This document defines these words as they should be interpreted in IETF documents.  This document specifies an Internet Best Current Practices for the Internet Community, and requests discussion and suggestions for improvements.</t>
          </abstract>
        </front>
        <seriesInfo name="BCP" value="14"/>
        <seriesInfo name="RFC" value="2119"/>
        <seriesInfo name="DOI" value="10.17487/RFC2119"/>
      </reference>
      <reference anchor="RFC8174" target="https://www.rfc-editor.org/info/rfc8174">
        <front>
          <title>Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words</title>
          <author fullname="B. Leiba" initials="B." surname="Leiba">
            <organization/>
          </author>
          <date month="May" year="2017"/>
          <abstract>
            <t>RFC 2119 specifies common key words that may be used in protocol  specifications.  This document aims to reduce the ambiguity by clarifying that only UPPERCASE usage of the key words have the  defined special meanings.</t>
          </abstract>
        </front>
        <seriesInfo name="BCP" value="14"/>
        <seriesInfo name="RFC" value="8174"/>
        <seriesInfo name="DOI" value="10.17487/RFC8174"/>
      </reference>
    </references>
  </back>
  <!-- ##markdown-source:
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
PlvI7DH5Lzm21QPwFwAA

-->

</rfc>
