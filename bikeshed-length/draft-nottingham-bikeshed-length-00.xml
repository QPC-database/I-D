<?xml version="1.0" encoding="UTF-8"?>
  <?xml-stylesheet type="text/xsl" href="rfc2629.xslt" ?>
  <!-- generated by https://github.com/cabo/kramdown-rfc2629 version 1.3.3 -->

<!DOCTYPE rfc SYSTEM "../Tools/rfcbootstrap/rfc2629.dtd" [
]>

<?rfc toc="yes"?>
<?rfc tocindent="yes"?>
<?rfc sortrefs="yes"?>
<?rfc symrefs="yes"?>
<?rfc strict="yes"?>
<?rfc compact="yes"?>
<?rfc comments="yes"?>
<?rfc inline="yes"?>

<rfc ipr="trust200902" docName="draft-nottingham-bikeshed-length-00" category="info">

  <front>
    <title>Advisory Content-Length for HTTP</title>

    <author initials="M." surname="Nottingham" fullname="Mark Nottingham">
      <organization></organization>
      <address>
        <email>mnot@mnot.net</email>
        <uri>https://www.mnot.net/</uri>
      </address>
    </author>

    <date />

    <area>General</area>
    <workgroup>HTTP</workgroup>
    <keyword>Internet-Draft</keyword>

    <abstract>


<t>The HTTP Content-Length header field is overloaded with (at least) two duties: message delimitation in HTTP/1, and metadata about the length of an incoming request body to the software handling it.</t>

<t>This causes confusion, and sometimes problems. This document proposes a new header to untangle these semantics (at least partially).</t>



    </abstract>


    <note title="Note to Readers">


<t><spanx style="emph">RFC EDITOR: please remove this section before publication</spanx></t>

<t>The issues list for this draft can be found at <eref target="https://github.com/mnot/I-D/labels/bikeshed-length">https://github.com/mnot/I-D/labels/bikeshed-length</eref>.</t>

<t>The most recent (often, unpublished) draft is at <eref target="https://mnot.github.io/I-D/bikeshed-length/">https://mnot.github.io/I-D/bikeshed-length/</eref>.</t>

<t>Recent changes are listed at <eref target="https://github.com/mnot/I-D/commits/gh-pages/bikeshed-length">https://github.com/mnot/I-D/commits/gh-pages/bikeshed-length</eref>.</t>

<t>See also the draft’s current status in the IETF datatracker, at
<eref target="https://datatracker.ietf.org/doc/draft-nottingham-bikeshed-length/">https://datatracker.ietf.org/doc/draft-nottingham-bikeshed-length/</eref>.</t>


    </note>


  </front>

  <middle>


<section anchor="introduction" title="Introduction">

<t>The HTTP Content-Length header field (<xref target="RFC7230"/>) is overloaded with (at least) two duties: message delimitation in HTTP/1, and metadata about the length of an incoming request body to the software handling it.</t>

<t>Message delimitation is a critical feature of the protocol; it allows more than one message to be sent in a given direction on a connection. It is also security-critical; if it is under attacker control, it’s possible to confuse a recipient about how requests and responses are associated in HTTP/1.1 (as “smuggling” attacks).</t>

<t>As such, it has been treated progressively more strictly in HTTP specifications. HTTP/1.1 introduced chunked transfer encoding, and forbade sending Content-Length when it is in use. From <xref target="RFC2616"/>:</t>

<t><list style='empty'>
  <t>Messages MUST NOT include both a Content-Length header field and a
   non-identity transfer-coding. If the message does include a non-
   identity transfer-coding, the Content-Length MUST be ignored.</t>

  <t>If a message is received with both a
  Transfer-Encoding header field and a Content-Length header field,
  the latter MUST be ignored.</t>
</list></t>

<t><xref target="RFC7230"/> strengthened that to:</t>

<t><list style='empty'>
  <t>A sender MUST NOT send a Content-Length header field in any message that contains a Transfer-Encoding header field.</t>

  <t>If a message is received with both a Transfer-Encoding and a Content-Length header field, the Transfer-Encoding overrides the Content-Length. Such a message might indicate an attempt to perform request smuggling (Section 9.5) or response splitting (Section 9.4) and ought to be handled as an error. A sender MUST remove the received Content-Length field prior to forwarding such a message downstream.</t>
</list></t>

<t>HTTP/2 (<xref target="RFC7540"/>) does not use Content-Length for message delimitation, but still requires it to match the number of bytes that its framing mechanism sends:</t>

<t><list style='empty'>
  <t>A request or response that includes a payload body can include a content-length header field. A request or response is also malformed if the value of a content-length header field does not equal the sum of the DATA frame payload lengths that form the body.</t>
</list></t>

<t>It further requires such malformed responses to generate a “hard” error, so that a downstream recipient that implements HTTP/1 can’t be attacked:</t>

<t><list style='empty'>
  <t>Intermediaries that process HTTP requests or responses (i.e., any intermediary not acting as a tunnel) MUST NOT forward a malformed request or response. Malformed requests or responses that are detected MUST be treated as a stream error (Section 5.4.2) of type PROTOCOL_ERROR.</t>

  <t>For malformed requests, a server MAY send an HTTP response prior to closing or resetting the stream. Clients MUST NOT accept a malformed response. Note that these requirements are intended to protect against several types of common attacks against HTTP; they are deliberately strict because being permissive can expose implementations to these vulnerabilities.</t>
</list></t>

<t>The currently proposed HTTP/3 specification <xref target="I-D.ietf-quic-http"/> has language similar to that in HTTP/2.</t>

<t>Unfortunately, this makes <spanx style="emph">other</spanx> uses of Content-Length more difficult to implement. In particular, many servers will reject a request without an explicit Content-Length using 411 (Length Required), but depending on the protocol version(s) between the user agent and the origin server, a Content-Length header might not make it all the way, or the request might be rejected.</t>

<t>Likewise, some applications would like to use Content-Length to indicate progress of a large download, but its successful traversal cannot be relied upon.</t>

<t>While it’s questionable whether all of the requirements above regarding Content-Length are honoured by implementations uniformly, there is enough diversity in implementation (particularly on the server side and in intermediaries) to make deployment of them daunting.</t>

<t>Therefore, this specification proposes a new HTTP header field to carry <spanx style="emph">advisory</spanx> content length information. It is intended only for these uses, and <spanx style="emph">not</spanx> message delimitation.</t>

<section anchor="notational-conventions" title="Notational Conventions">

<t>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”,
“RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as
described in BCP 14 <xref target="RFC2119"/> <xref target="RFC8174"/> when, and only when, they appear in all capitals, as
shown here.</t>

</section>
</section>
<section anchor="the-bikeshed-length-http-header-field" title="The Bikeshed-Length HTTP Header Field">

<t>NOTE: The final name of this header field will be selected using a to-be-defined process. Warm up your paintbrushes…</t>

<t>The Bikeshed-Length HTTP header field is a HTTP Structured Field <xref target="I-D.ietf-httpbis-header-structure"/> that conveys an advisory content length for the message body:</t>

<figure><artwork type="abnf"><![CDATA[
Bikeshed-Length = sh-item
]]></artwork></figure>

<t>Its value MUST be an Integer (Section x.x of <xref target="I-D.ietf-httpbis-header-structure"/>), indicating a decimal number of octets for a potential payload body.</t>

<t>Note that it is specifically a header field; it is not allowed to occur in trailer sections, and SHOULD be ignored if encountered there.</t>

<section anchor="example" title="Example">

<t>A resource might allow requests with bodies up to a given size. If an incoming request omits both Content-Length and Bikeshed-Length, they can respond with 411 (Length Required). If either request header field is present, and the value given is not acceptable, they can respond with 413 (Payload Too Large). If Bikeshed-Length is used and deemed to be acceptable, the resource still ought to monitor the number of incoming bytes to assure that they do not exceed the anticipated value.</t>

</section>
</section>
<section anchor="iana-considerations" title="IANA Considerations">

<t>TBD</t>

</section>
<section anchor="security-considerations" title="Security Considerations">

<t>The Value of Bikeshed-Length is advisory only; software that uses it will need to monitor the actual number of octets received to assure that it is not exceeded, and take appropriate action if it is.</t>

</section>


  </middle>

  <back>

    <references title='Normative References'>





<reference  anchor="RFC2119" target='https://www.rfc-editor.org/info/rfc2119'>
<front>
<title>Key words for use in RFCs to Indicate Requirement Levels</title>
<author initials='S.' surname='Bradner' fullname='S. Bradner'><organization /></author>
<date year='1997' month='March' />
<abstract><t>In many standards track documents several words are used to signify the requirements in the specification.  These words are often capitalized. This document defines these words as they should be interpreted in IETF documents.  This document specifies an Internet Best Current Practices for the Internet Community, and requests discussion and suggestions for improvements.</t></abstract>
</front>
<seriesInfo name='BCP' value='14'/>
<seriesInfo name='RFC' value='2119'/>
<seriesInfo name='DOI' value='10.17487/RFC2119'/>
</reference>



<reference  anchor="RFC7230" target='https://www.rfc-editor.org/info/rfc7230'>
<front>
<title>Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing</title>
<author initials='R.' surname='Fielding' fullname='R. Fielding' role='editor'><organization /></author>
<author initials='J.' surname='Reschke' fullname='J. Reschke' role='editor'><organization /></author>
<date year='2014' month='June' />
<abstract><t>The Hypertext Transfer Protocol (HTTP) is a stateless application-level protocol for distributed, collaborative, hypertext information systems.  This document provides an overview of HTTP architecture and its associated terminology, defines the &quot;http&quot; and &quot;https&quot; Uniform Resource Identifier (URI) schemes, defines the HTTP/1.1 message syntax and parsing requirements, and describes related security concerns for implementations.</t></abstract>
</front>
<seriesInfo name='RFC' value='7230'/>
<seriesInfo name='DOI' value='10.17487/RFC7230'/>
</reference>



<reference  anchor="RFC8174" target='https://www.rfc-editor.org/info/rfc8174'>
<front>
<title>Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words</title>
<author initials='B.' surname='Leiba' fullname='B. Leiba'><organization /></author>
<date year='2017' month='May' />
<abstract><t>RFC 2119 specifies common key words that may be used in protocol  specifications.  This document aims to reduce the ambiguity by clarifying that only UPPERCASE usage of the key words have the  defined special meanings.</t></abstract>
</front>
<seriesInfo name='BCP' value='14'/>
<seriesInfo name='RFC' value='8174'/>
<seriesInfo name='DOI' value='10.17487/RFC8174'/>
</reference>



<reference anchor="I-D.ietf-httpbis-header-structure">
<front>
<title>Structured Field Values for HTTP</title>

<author initials='M' surname='Nottingham' fullname='Mark Nottingham'>
    <organization />
</author>

<author initials='P' surname='Kamp' fullname='Poul-Henning Kamp'>
    <organization />
</author>

<date month='March' day='15' year='2020' />

<abstract><t>This document describes a set of data types and associated algorithms that are intended to make it easier and safer to define and handle HTTP header and trailer fields, known as "Structured Fields", or "Structured Headers".  It is intended for use by specifications of new HTTP fields that wish to use a common syntax that is more restrictive than traditional HTTP field values.</t></abstract>

</front>

<seriesInfo name='Internet-Draft' value='draft-ietf-httpbis-header-structure-17' />
<format type='TXT'
        target='http://www.ietf.org/internet-drafts/draft-ietf-httpbis-header-structure-17.txt' />
</reference>




    </references>

    <references title='Informative References'>





<reference  anchor="RFC2616" target='https://www.rfc-editor.org/info/rfc2616'>
<front>
<title>Hypertext Transfer Protocol -- HTTP/1.1</title>
<author initials='R.' surname='Fielding' fullname='R. Fielding'><organization /></author>
<author initials='J.' surname='Gettys' fullname='J. Gettys'><organization /></author>
<author initials='J.' surname='Mogul' fullname='J. Mogul'><organization /></author>
<author initials='H.' surname='Frystyk' fullname='H. Frystyk'><organization /></author>
<author initials='L.' surname='Masinter' fullname='L. Masinter'><organization /></author>
<author initials='P.' surname='Leach' fullname='P. Leach'><organization /></author>
<author initials='T.' surname='Berners-Lee' fullname='T. Berners-Lee'><organization /></author>
<date year='1999' month='June' />
<abstract><t>HTTP has been in use by the World-Wide Web global information initiative since 1990. This specification defines the protocol referred to as &quot;HTTP/1.1&quot;, and is an update to RFC 2068.  [STANDARDS-TRACK]</t></abstract>
</front>
<seriesInfo name='RFC' value='2616'/>
<seriesInfo name='DOI' value='10.17487/RFC2616'/>
</reference>



<reference  anchor="RFC7540" target='https://www.rfc-editor.org/info/rfc7540'>
<front>
<title>Hypertext Transfer Protocol Version 2 (HTTP/2)</title>
<author initials='M.' surname='Belshe' fullname='M. Belshe'><organization /></author>
<author initials='R.' surname='Peon' fullname='R. Peon'><organization /></author>
<author initials='M.' surname='Thomson' fullname='M. Thomson' role='editor'><organization /></author>
<date year='2015' month='May' />
<abstract><t>This specification describes an optimized expression of the semantics of the Hypertext Transfer Protocol (HTTP), referred to as HTTP version 2 (HTTP/2).  HTTP/2 enables a more efficient use of network resources and a reduced perception of latency by introducing header field compression and allowing multiple concurrent exchanges on the same connection.  It also introduces unsolicited push of representations from servers to clients.</t><t>This specification is an alternative to, but does not obsolete, the HTTP/1.1 message syntax.  HTTP's existing semantics remain unchanged.</t></abstract>
</front>
<seriesInfo name='RFC' value='7540'/>
<seriesInfo name='DOI' value='10.17487/RFC7540'/>
</reference>



<reference anchor="I-D.ietf-quic-http">
<front>
<title>Hypertext Transfer Protocol Version 3 (HTTP/3)</title>

<author initials='M' surname='Bishop' fullname='Mike Bishop'>
    <organization />
</author>

<date month='February' day='21' year='2020' />

<abstract><t>The QUIC transport protocol has several features that are desirable in a transport for HTTP, such as stream multiplexing, per-stream flow control, and low-latency connection establishment.  This document describes a mapping of HTTP semantics over QUIC.  This document also identifies HTTP/2 features that are subsumed by QUIC, and describes how HTTP/2 extensions can be ported to HTTP/3.</t></abstract>

</front>

<seriesInfo name='Internet-Draft' value='draft-ietf-quic-http-27' />
<format type='TXT'
        target='http://www.ietf.org/internet-drafts/draft-ietf-quic-http-27.txt' />
</reference>




    </references>



  </back>

<!-- ##markdown-source:
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
hcqWGwAA

-->

</rfc>

